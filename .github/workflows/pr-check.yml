name: Pull Request Check

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

jobs:
  pr-validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run test coverage
        run: npm run test:coverage

      - name: Build package
        run: npm run build

      - name: Verify package contents
        run: |
          echo "Verifying package structure..."
          npm pack --dry-run
          echo "Build output verification:"
          ls -la dist/

      - name: Check package size
        run: |
          PACKAGE_SIZE=$(npm pack --dry-run | grep -o '[0-9.]*[kMG]B' | tail -1)
          echo "ğŸ“¦ Package size: $PACKAGE_SIZE"

      - name: Validate package.json
        run: |
          echo "Validating package.json structure..."
          node -e "
            const pkg = require('./package.json');
            const required = ['name', 'version', 'description', 'main', 'types'];
            const missing = required.filter(field => !pkg[field]);
            if (missing.length > 0) {
              console.error('âŒ Missing required fields:', missing);
              process.exit(1);
            }
            console.log('âœ… Package.json validation passed');
          "

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');

            // Get package info
            const pkg = require('./package.json');
            const packageSize = execSync('npm pack --dry-run | grep -o "[0-9.]*[kMG]B" | tail -1', {encoding: 'utf8'}).trim();

            const comment = `## ğŸ” Pull Request Validation Report

            âœ… **Tests**: Passed
            âœ… **Build**: Successful
            âœ… **Package**: Valid

            ### ğŸ“¦ Package Information
            - **Name**: ${pkg.name}
            - **Version**: ${pkg.version}
            - **Size**: ${packageSize}
            - **Main**: ${pkg.main}
            - **Types**: ${pkg.types}

            ### ğŸ§ª Test Coverage
            Test coverage report is available in the workflow logs.

            ### âœ¨ Ready for merge!
            This PR passed all validation checks and is ready to be merged.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });